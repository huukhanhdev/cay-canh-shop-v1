<%- include('../partials/header', { title }) %>

<h2>Thanh toán</h2>

<% if (error) { %>
  <p class="alert alert-error"><%= error %></p>
<% } %>

<% const formData = prefill || {}; %>
<% const isLoggedIn = typeof locals.isLoggedIn !== 'undefined' ? locals.isLoggedIn : false; %>
<% const savedAddressList = Array.isArray(locals.savedAddresses)
  ? locals.savedAddresses
  : (typeof savedAddresses !== 'undefined' && Array.isArray(savedAddresses) ? savedAddresses : []); %>

<div class="checkout-layout">
  <form class="checkout-form" method="POST" action="/checkout" id="checkoutForm">
    <div class="step-indicator" style="margin-bottom:12px">
      <span id="stepIndicator1"><strong>1.</strong> Thông tin giao hàng</span>
      <span>→</span>
      <span id="stepIndicator2"><strong>2.</strong> Thanh toán</span>
      <span>→</span>
      <span id="stepIndicator3"><strong>3.</strong> Xác nhận</span>
    </div>

    <section id="step-shipping">
    <% if (!isLoggedIn) { %>
      <label>Email
        <input name="email" type="email" value="<%= formData.email || '' %>" required>
      </label>
      <p class="form-hint">Chúng tôi sẽ tạo tài khoản tự động bằng email này để bạn theo dõi đơn hàng.</p>
    <% } else { %>
      <label>Email
        <input type="email" value="<%= locals.userEmail %>" disabled>
      </label>
    <% } %>
    <label>Họ tên người nhận<input name="fullName" value="<%= formData.fullName || '' %>" required></label>
    <label>Số điện thoại<input name="phone" value="<%= formData.phone || '' %>" required></label>
    <label>Địa chỉ (đường)<input name="street" value="<%= formData.street || '' %>" required></label>
    <% if (isLoggedIn && savedAddressList.length) { %>
      <label>
        Chọn địa chỉ đã lưu
        <select id="savedAddressSelect">
          <option value="">-- Chọn địa chỉ --</option>
          <% savedAddressList.forEach((addr, idx) => { %>
            <option value="<%= idx %>">
              <%= addr.fullName || 'Không tên' %> - <%= [addr.street, addr.district, addr.city].filter(Boolean).join(', ') %>
              <%= addr.isDefault ? '(Mặc định)' : '' %>
            </option>
          <% }) %>
        </select>
      </label>
    <% } %>
    <div class="form-grid" data-location-form>
      <label>
        Tỉnh/Thành phố
        <select name="city" data-city-select data-placeholder="Chọn tỉnh/thành" data-selected="<%= formData.city || '' %>" required>
          <option value="">Chọn tỉnh/thành</option>
        </select>
      </label>
      <label>
        Quận/Huyện
        <select name="district" data-district-select data-placeholder="Chọn quận/huyện" data-selected="<%= formData.district || '' %>" required>
          <option value="">Chọn quận/huyện</option>
        </select>
      </label>
    </div>
    <label>Ghi chú thêm<textarea name="note" rows="3"><%= formData.note || '' %></textarea></label>
    <div class="form-actions">
      <button class="btn btn-primary" id="btnToPayment" type="button">Tiếp tục</button>
    </div>
    </section>

    <section id="step-payment" style="display:none">
      <h3>Phương thức thanh toán</h3>
      <label style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
        <input type="radio" name="paymentMethod" value="cod" checked> 
        <span>Thanh toán khi nhận hàng (COD)</span>
      </label>
      <% if (isLoggedIn) { %>
      <label style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
        <input type="radio" name="paymentMethod" value="momo"> 
        <span>Thanh toán Momo <img src="https://developers.momo.vn/v3/img/logo.svg" alt="Momo" style="height:20px;vertical-align:middle;margin-left:4px"></span>
      </label>
      <label style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
        <input type="radio" name="paymentMethod" value="vnpay"> 
        <span>Thanh toán VNPay <img src="https://vnpay.vn/s1/statics.vnpay.vn/2023/6/0oxhzjmxbksr1686814746087.png" alt="VNPay" style="height:20px;vertical-align:middle;margin-left:4px"></span>
      </label>
      <% } %>
      <div class="form-actions">
        <button class="btn btn-secondary" id="btnBackToShipping" type="button">Quay lại</button>
        <button class="btn btn-primary" id="btnToReview" type="button">Tiếp tục</button>
      </div>
    </section>

    <section id="step-review" style="display:none">
      <h3>Kiểm tra và xác nhận</h3>
      <p>Vui lòng kiểm tra lại thông tin và tổng tiền ở bên phải trước khi đặt hàng.</p>
      <div class="form-actions">
        <button class="btn btn-secondary" id="btnBackToPayment" type="button">Quay lại</button>
        <button class="btn btn-primary" id="btnSubmitOrder" type="button">Đặt hàng</button>
      </div>
    </section>
  </form>

  <aside class="checkout-summary">
    <h3>Tóm tắt đơn hàng</h3>
    <ul>
      <% cart.items.forEach((item) => { %>
        <li>
          <strong><%= item.productName %></strong>
          <% if (item.variant && item.variant.variantName) { %>
            <div class="meta">Biến thể: <%= item.variant.variantName %></div>
          <% } %>
          <span>x <%= item.quantity %> — <%= item.subTotal.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }) %></span>
        </li>
      <% }) %>
    </ul>
    <div class="coupon-box">
      <label>Mã giảm giá</label>
      <div style="display:flex; gap:8px; align-items:center">
        <input id="couponInput" maxlength="5" placeholder="ABCDE" style="text-transform:uppercase" />
        <button class="btn btn-secondary" id="applyCouponBtn" type="button">Áp dụng</button>
        <% if (appliedCoupon) { %>
          <button class="btn btn-danger" id="removeCouponBtn" type="button">Bỏ mã</button>
        <% } %>
      </div>
      <div id="couponMsg" class="form-hint" style="color:var(--muted)"></div>
      <% if (appliedCoupon) { %>
        <p class="form-hint">Đang áp dụng: <strong><%= appliedCoupon.code %></strong></p>
      <% } %>
    </div>

    <% const pointsAvailable = typeof locals.loyaltyPoints === 'number' ? locals.loyaltyPoints : 0; %>
    <div class="coupon-box">
      <label>Điểm thưởng</label>
      <p class="form-hint">Bạn đang có: <strong><%= pointsAvailable.toLocaleString('vi-VN') %></strong> điểm (1 điểm = 1.000 VND).</p>
      <div style="display:flex; gap:8px; align-items:center">
        <input id="pointsInput" name="pointsToUse" type="number" min="0" step="1" placeholder="Số điểm muốn dùng" />
        <button class="btn btn-secondary" id="applyPointsBtn" type="button">Dùng điểm</button>
        <button class="btn btn-danger" id="removePointsBtn" type="button" style="display:none">Bỏ điểm</button>
      </div>
      <div id="pointsMsg" class="form-hint" style="color:var(--muted)"></div>
    </div>

    <div class="summary-line"><strong>Tạm tính:</strong> <span id="summary-subtotal"><%= (summary?.subtotal || cart.totalPrice).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }) %></span></div>
    <div class="summary-line"><strong>Giảm:</strong> <span id="summary-discount">-<%= (summary?.discount || 0).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }) %></span></div>
    <div class="summary-line"><strong>Điểm đã dùng:</strong> <span id="summary-points"><%= (0).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }) %></span></div>
    <div class="summary-line"><strong>Thuế (VAT):</strong> <span id="summary-tax"><%= (summary?.tax || 0).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }) %></span></div>
    <div class="summary-line"><strong>Phí vận chuyển:</strong> <span id="summary-shipping"><%= (summary?.shipping || 0).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }) %></span></div>
    <div class="summary-line total"><strong>Tổng cộng:</strong> <span id="summary-total"><%= (summary?.total || cart.totalPrice).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }) %></span></div>
  </aside>
</div>

<%- include('../partials/location-script', { locations }) %>
<script>
  (function() {
    // Step navigation
    const stepShipping = document.getElementById('step-shipping');
    const stepPayment = document.getElementById('step-payment');
    const stepReview = document.getElementById('step-review');
    const btnToPayment = document.getElementById('btnToPayment');
    const btnBackToShipping = document.getElementById('btnBackToShipping');
    const btnToReview = document.getElementById('btnToReview');
    const btnBackToPayment = document.getElementById('btnBackToPayment');
    const btnSubmitOrder = document.getElementById('btnSubmitOrder');
        // Points apply/remove (client-side reflect only; submitted with form)
        const pointsInput = document.getElementById('pointsInput');
        const applyPointsBtn = document.getElementById('applyPointsBtn');
        const removePointsBtn = document.getElementById('removePointsBtn');
        const pointsMsg = document.getElementById('pointsMsg');
        const summarySubtotalEl = document.getElementById('summary-subtotal');
        const summaryDiscountEl = document.getElementById('summary-discount');
        const summaryTaxEl = document.getElementById('summary-tax');
        const summaryShippingEl = document.getElementById('summary-shipping');
        const summaryTotalEl = document.getElementById('summary-total');
        const summaryPointsEl = document.getElementById('summary-points');

        function parseCurrency(text) {
          try {
            const raw = String(text);
            // Strip all non-digits; treat dots as thousands separators (remove them)
            const digitsOnly = raw.replace(/\D/g, '');
            return Number(digitsOnly) || 0;
          } catch { return 0; }
        }

    function updateSummaryWithPoints(points) {
      const subtotal = parseCurrency(summarySubtotalEl.textContent);
      const discount = parseCurrency(summaryDiscountEl.textContent);
      const shipping = parseCurrency(summaryShippingEl.textContent);
      const tax = parseCurrency(summaryTaxEl.textContent);
      // 1 điểm = 1.000 VND; chỉ giảm đến khi (subtotal - discount - used) >= 0
      const amountAfterDiscount = Math.max(0, subtotal - discount);
      const maxPointsRedeemable = Math.floor(amountAfterDiscount / 1000);
      const actualPoints = Math.min((points || 0), maxPointsRedeemable);
      const used = actualPoints * 1000;
      const usedText = used.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
      summaryPointsEl.textContent = used ? ('-' + usedText) : ('0 ₫');
      const total = Math.max(0, subtotal - discount - used + tax + shipping);
      summaryTotalEl.textContent = total.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
    }        applyPointsBtn?.addEventListener('click', () => {
          const val = Math.max(0, Number(pointsInput?.value || 0) || 0);
          if (!val) { pointsMsg.textContent = 'Nhập số điểm muốn dùng'; return; }
          removePointsBtn.style.display = '';
          pointsMsg.textContent = `Đang dùng: ${val.toLocaleString('vi-VN')} điểm`;
          updateSummaryWithPoints(val);
        });

        removePointsBtn?.addEventListener('click', () => {
          pointsInput.value = '';
          pointsMsg.textContent = '';
          removePointsBtn.style.display = 'none';
          updateSummaryWithPoints(0);
        });
    const ind1 = document.getElementById('stepIndicator1');
    const ind2 = document.getElementById('stepIndicator2');
    const ind3 = document.getElementById('stepIndicator3');
    const form = document.getElementById('checkoutForm');

    function showStep(step) {
      stepShipping.style.display = step === 1 ? '' : 'none';
      stepPayment.style.display = step === 2 ? '' : 'none';
      stepReview.style.display = step === 3 ? '' : 'none';
      ind1.style.textDecoration = step === 1 ? 'underline' : '';
      ind2.style.textDecoration = step === 2 ? 'underline' : '';
      ind3.style.textDecoration = step === 3 ? 'underline' : '';
      
      // Disable validation on hidden fields
      const allInputs = document.querySelectorAll('#checkoutForm input, #checkoutForm select, #checkoutForm textarea');
      allInputs.forEach(inp => {
        const section = inp.closest('section');
        if (section && section.style.display === 'none') {
          inp.setAttribute('data-was-required', inp.hasAttribute('required'));
          inp.removeAttribute('required');
        } else if (inp.hasAttribute('data-was-required')) {
          inp.setAttribute('required', '');
        }
      });
    }
    
    if (btnToPayment) {
      btnToPayment.addEventListener('click', () => {
        // Validate step 1 fields before moving
        const form = document.getElementById('checkoutForm');
        const step1Inputs = stepShipping.querySelectorAll('input[required], select[required]');
        let valid = true;
        step1Inputs.forEach(inp => {
          if (!inp.checkValidity()) {
            valid = false;
            inp.reportValidity();
          }
        });
        if (valid) showStep(2);
      });
    }
    if (btnBackToShipping) btnBackToShipping.addEventListener('click', () => showStep(1));
    if (btnToReview) btnToReview.addEventListener('click', () => showStep(3));
    if (btnBackToPayment) btnBackToPayment.addEventListener('click', () => showStep(2));
    
    if (btnSubmitOrder) {
      btnSubmitOrder.addEventListener('click', (e) => {
        console.log('Submit button clicked');
        e.preventDefault();
        
        // Check payment method
        const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
        
        if (paymentMethod === 'momo') {
          // Momo payment flow
          btnSubmitOrder.disabled = true;
          btnSubmitOrder.textContent = 'Đang xử lý...';
          
          fetch('/payment/momo/create', { 
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          })
          .then(r => r.json())
          .then(data => {
            if (data.ok && data.payUrl) {
              window.location.href = data.payUrl;
            } else {
              alert('Lỗi: ' + (data.error || 'Không tạo được phiên thanh toán'));
              btnSubmitOrder.disabled = false;
              btnSubmitOrder.textContent = 'Đặt hàng';
            }
          })
          .catch(err => {
            alert('Lỗi kết nối: ' + err.message);
            btnSubmitOrder.disabled = false;
            btnSubmitOrder.textContent = 'Đặt hàng';
          });
        } else {
          // COD: submit form normally
          // Re-enable all required fields before submit
          const allInputs = form.querySelectorAll('input, select, textarea');
          allInputs.forEach(inp => {
            if (inp.hasAttribute('data-was-required')) {
              inp.setAttribute('required', '');
            }
          });
          
          console.log('Submitting form...');
          form.submit();
        }
      });
    }

    // Coupon handling
    const currency = (v) => (v || 0).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
    function updateSummary(summary) {
      const el = (id) => document.getElementById(id);
      if (el('summary-subtotal')) el('summary-subtotal').textContent = currency(summary.subtotal);
      if (el('summary-discount')) el('summary-discount').textContent = '-' + currency(summary.discount);
      if (el('summary-tax')) el('summary-tax').textContent = currency(summary.tax);
      if (el('summary-shipping')) el('summary-shipping').textContent = currency(summary.shipping);
      if (el('summary-total')) el('summary-total').textContent = currency(summary.total);
    }

    const couponInput = document.getElementById('couponInput');
    const applyBtn = document.getElementById('applyCouponBtn');
    const removeBtn = document.getElementById('removeCouponBtn');
    const couponMsg = document.getElementById('couponMsg');
    if (applyBtn) {
      applyBtn.addEventListener('click', () => {
        const code = (couponInput && couponInput.value || '').trim().toUpperCase();
        if (!code) { couponMsg.textContent = 'Nhập mã 5 ký tự'; return; }
        const body = new URLSearchParams(); body.set('code', code);
        fetch('/checkout/apply-coupon', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: body.toString() })
          .then(r => r.json())
          .then((res) => {
            if (!res.ok) { couponMsg.textContent = res.error || 'Mã không hợp lệ'; return; }
            updateSummary(res.summary);
            couponMsg.textContent = 'Áp dụng mã thành công: ' + (res.appliedCoupon && res.appliedCoupon.code || code);
          })
          .catch(() => { couponMsg.textContent = 'Có lỗi xảy ra'; });
      });
    }
    if (removeBtn) {
      removeBtn.addEventListener('click', () => {
        fetch('/checkout/remove-coupon', { method: 'POST' })
          .then(r => r.json())
          .then((res) => {
            if (!res.ok) { couponMsg.textContent = res.error || 'Không thể bỏ mã'; return; }
            updateSummary(res.summary);
            couponMsg.textContent = 'Đã bỏ mã giảm giá.';
          })
          .catch(() => { couponMsg.textContent = 'Có lỗi xảy ra'; });
      });
    }
  })();
</script>
<% if (isLoggedIn && savedAddressList.length) { %>
  <script>
    (function () {
      const addresses = <%- JSON.stringify(savedAddressList) %>;
      const select = document.getElementById('savedAddressSelect');
      if (!select) return;
      const fullNameInput = document.querySelector('input[name="fullName"]');
      const phoneInput = document.querySelector('input[name="phone"]');
      const streetInput = document.querySelector('input[name="street"]');
      const citySelect = document.querySelector('select[name="city"]');
      const districtSelect = document.querySelector('select[name="district"]');
      const noteInput = document.querySelector('textarea[name="note"]');

      select.addEventListener('change', () => {
        const idx = Number(select.value);
        if (Number.isNaN(idx) || idx < 0 || idx >= addresses.length) return;
        const addr = addresses[idx];
        if (fullNameInput) fullNameInput.value = addr.fullName || '';
        if (phoneInput) phoneInput.value = addr.phone || '';
        if (streetInput) streetInput.value = addr.street || '';
        if (noteInput) noteInput.value = '';
        if (citySelect) {
          citySelect.value = addr.city || '';
          citySelect.dispatchEvent(new Event('change'));
          setTimeout(() => {
            if (districtSelect) districtSelect.value = addr.district || '';
          }, 0);
        }
      });
    })();
  </script>
<% } %>
<%- include('../partials/footer') %>
