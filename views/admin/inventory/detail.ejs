<%- include('../../partials/header', { title }) %>

<div class="admin-container">
  <div class="admin-header">
    <h2><%= title %></h2>
    <div class="admin-actions">
      <a href="/admin/inventory" class="btn btn-secondary">‚Üê Quay l·∫°i danh s√°ch kho</a>
      <a href="/admin/products/<%= product._id %>/edit" class="btn btn-secondary">S·ª≠a s·∫£n ph·∫©m</a>
    </div>
  </div>

  <% if (msg) { %>
    <% if (msg === 'imported') { %>
      <p class="alert alert-success">Nh·∫≠p kho th√†nh c√¥ng!</p>
    <% } else if (msg === 'exported') { %>
      <p class="alert alert-success">Xu·∫•t kho th√†nh c√¥ng!</p>
    <% } else if (msg === 'adjusted') { %>
      <p class="alert alert-success">ƒêi·ªÅu ch·ªânh t·ªìn kho th√†nh c√¥ng!</p>
    <% } else if (msg === 'invalid_quantity') { %>
      <p class="alert alert-error">S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá.</p>
    <% } else if (msg === 'variant_not_found') { %>
      <p class="alert alert-error">Kh√¥ng t√¨m th·∫•y bi·∫øn th·ªÉ.</p>
    <% } else if (msg === 'error') { %>
      <p class="alert alert-error">ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng th·ª≠ l·∫°i.</p>
    <% } %>
  <% } %>

  <div class="inventory-detail-grid">
    <!-- Product Info -->
    <div class="inventory-card">
      <h3>Th√¥ng tin s·∫£n ph·∫©m</h3>
      <% 
        const productImg = Array.isArray(product.img) && product.img.length > 0 ? product.img[0] : '/uploads/products/default.jpg';
      %>
      <img src="<%= productImg %>" alt="<%= product.name %>" class="product-detail-img">
      <p><strong>T√™n:</strong> <%= product.name %></p>
      <p><strong>SKU:</strong> <%= product.sku || '-' %></p>
      <p><strong>Lo·∫°i:</strong> <%= product.type === 'plant' ? 'C√¢y' : 'Ch·∫≠u' %></p>
      <p><strong>Gi√°:</strong> <%= product.price.toLocaleString('vi-VN') %>ƒë</p>
    </div>

    <!-- Stock Management -->
    <div class="inventory-card">
      <h3>Qu·∫£n l√Ω t·ªìn kho</h3>
      
      <% 
        const hasVariants = product.variants && product.variants.length > 0;
      %>
      
      <% if (!hasVariants) { %>
        <!-- Simple product stock -->
        <div class="stock-section">
          <div class="stock-display">
            <span class="stock-label">T·ªìn kho hi·ªán t·∫°i:</span>
            <span class="stock-value <%= product.inStock === 0 ? 'out-stock' : (product.inStock <= 10 ? 'low-stock' : 'in-stock') %>">
              <%= product.inStock || 0 %>
            </span>
          </div>

          <!-- Import form -->
          <details class="action-details">
            <summary>‚ûï Nh·∫≠p kho</summary>
            <form method="POST" action="/admin/inventory/<%= product._id %>/import" class="stock-form">
              <label>S·ªë l∆∞·ª£ng nh·∫≠p:</label>
              <input type="number" name="quantity" min="1" required>
              
              <label>L√Ω do:</label>
              <input type="text" name="reason" placeholder="VD: Nh·∫≠p h√†ng t·ª´ nh√† cung c·∫•p">
              
              <label>Ghi ch√∫:</label>
              <textarea name="note" rows="2" placeholder="Th√¥ng tin th√™m (kh√¥ng b·∫Øt bu·ªôc)"></textarea>
              
              <button type="submit" class="btn btn-primary">X√°c nh·∫≠n nh·∫≠p kho</button>
            </form>
          </details>

          <!-- Export form -->
          <details class="action-details">
            <summary>‚ûñ Xu·∫•t kho</summary>
            <form method="POST" action="/admin/inventory/<%= product._id %>/export" class="stock-form">
              <label>S·ªë l∆∞·ª£ng xu·∫•t:</label>
              <input type="number" name="quantity" min="1" max="<%= product.inStock || 0 %>" required>
              
              <label>L√Ω do:</label>
              <input type="text" name="reason" placeholder="VD: H∆∞ h·ªèng, m·∫•t m√°t, khuy·∫øn m√£i">
              
              <label>Ghi ch√∫:</label>
              <textarea name="note" rows="2" placeholder="Th√¥ng tin th√™m (kh√¥ng b·∫Øt bu·ªôc)"></textarea>
              
              <button type="submit" class="btn btn-danger">X√°c nh·∫≠n xu·∫•t kho</button>
            </form>
          </details>

          <!-- Adjust form -->
          <details class="action-details">
            <summary>‚öôÔ∏è ƒêi·ªÅu ch·ªânh t·ªìn kho</summary>
            <form method="POST" action="/admin/inventory/<%= product._id %>/adjust" class="stock-form">
              <label>S·ªë l∆∞·ª£ng m·ªõi:</label>
              <input type="number" name="newQuantity" min="0" value="<%= product.inStock || 0 %>" required>
              
              <label>L√Ω do:</label>
              <input type="text" name="reason" placeholder="VD: Ki·ªÉm k√™, s·ª≠a l·ªói nh·∫≠p li·ªáu">
              
              <label>Ghi ch√∫:</label>
              <textarea name="note" rows="2" placeholder="Th√¥ng tin th√™m (kh√¥ng b·∫Øt bu·ªôc)"></textarea>
              
              <button type="submit" class="btn btn-warning">X√°c nh·∫≠n ƒëi·ªÅu ch·ªânh</button>
            </form>
          </details>
        </div>
      <% } else { %>
        <!-- Variants stock -->
        <div class="variants-section">
          <p class="meta">S·∫£n ph·∫©m c√≥ <%= product.variants.length %> bi·∫øn th·ªÉ:</p>
          
          <% product.variants.forEach((variant, idx) => { %>
            <div class="variant-item">
              <div class="variant-header">
                <strong><%= variant.variantName || `Bi·∫øn th·ªÉ ${idx + 1}` %></strong>
                <% if (variant.size) { %><span class="meta">Size: <%= variant.size %></span><% } %>
                <% if (variant.color) { %><span class="meta">M√†u: <%= variant.color %></span><% } %>
              </div>
              
              <div class="stock-display">
                <span class="stock-label">T·ªìn kho:</span>
                <span class="stock-value <%= variant.stock === 0 ? 'out-stock' : (variant.stock <= 10 ? 'low-stock' : 'in-stock') %>">
                  <%= variant.stock || 0 %>
                </span>
              </div>

              <!-- Import variant -->
              <details class="action-details">
                <summary>‚ûï Nh·∫≠p kho</summary>
                <form method="POST" action="/admin/inventory/<%= product._id %>/import" class="stock-form">
                  <input type="hidden" name="variantId" value="<%= variant._id %>">
                  <label>S·ªë l∆∞·ª£ng nh·∫≠p:</label>
                  <input type="number" name="quantity" min="1" required>
                  <label>L√Ω do:</label>
                  <input type="text" name="reason" placeholder="L√Ω do nh·∫≠p kho">
                  <label>Ghi ch√∫:</label>
                  <textarea name="note" rows="2"></textarea>
                  <button type="submit" class="btn btn-primary">Nh·∫≠p kho</button>
                </form>
              </details>

              <!-- Export variant -->
              <details class="action-details">
                <summary>‚ûñ Xu·∫•t kho</summary>
                <form method="POST" action="/admin/inventory/<%= product._id %>/export" class="stock-form">
                  <input type="hidden" name="variantId" value="<%= variant._id %>">
                  <label>S·ªë l∆∞·ª£ng xu·∫•t:</label>
                  <input type="number" name="quantity" min="1" max="<%= variant.stock || 0 %>" required>
                  <label>L√Ω do:</label>
                  <input type="text" name="reason" placeholder="L√Ω do xu·∫•t kho">
                  <label>Ghi ch√∫:</label>
                  <textarea name="note" rows="2"></textarea>
                  <button type="submit" class="btn btn-danger">Xu·∫•t kho</button>
                </form>
              </details>

              <!-- Adjust variant -->
              <details class="action-details">
                <summary>‚öôÔ∏è ƒêi·ªÅu ch·ªânh</summary>
                <form method="POST" action="/admin/inventory/<%= product._id %>/adjust" class="stock-form">
                  <input type="hidden" name="variantId" value="<%= variant._id %>">
                  <label>S·ªë l∆∞·ª£ng m·ªõi:</label>
                  <input type="number" name="newQuantity" min="0" value="<%= variant.stock || 0 %>" required>
                  <label>L√Ω do:</label>
                  <input type="text" name="reason" placeholder="L√Ω do ƒëi·ªÅu ch·ªânh">
                  <label>Ghi ch√∫:</label>
                  <textarea name="note" rows="2"></textarea>
                  <button type="submit" class="btn btn-warning">ƒêi·ªÅu ch·ªânh</button>
                </form>
              </details>
            </div>
          <% }) %>
        </div>
      <% } %>
    </div>
  </div>

  <!-- Inventory History -->
  <div class="inventory-card" style="margin-top: 2rem;">
    <h3>L·ªãch s·ª≠ xu·∫•t nh·∫≠p kho (50 giao d·ªãch g·∫ßn nh·∫•t)</h3>
    
    <% if (logs.length === 0) { %>
      <p class="meta">Ch∆∞a c√≥ l·ªãch s·ª≠ xu·∫•t nh·∫≠p kho.</p>
    <% } else { %>
      <table class="log-table">
        <thead>
          <tr>
            <th>Th·ªùi gian</th>
            <th>Lo·∫°i</th>
            <th>Bi·∫øn th·ªÉ</th>
            <th>S·ªë l∆∞·ª£ng</th>
            <th>T·ªìn kho</th>
            <th>L√Ω do</th>
            <th>Ng∆∞·ªùi th·ª±c hi·ªán</th>
          </tr>
        </thead>
        <tbody>
          <% logs.forEach(log => { 
            const typeLabel = {
              import: '‚ûï Nh·∫≠p kho',
              export: '‚ûñ Xu·∫•t kho',
              adjustment: '‚öôÔ∏è ƒêi·ªÅu ch·ªânh',
              sale: 'üõí B√°n h√†ng'
            };
            const typeClass = {
              import: 'log-import',
              export: 'log-export',
              adjustment: 'log-adjust',
              sale: 'log-sale'
            };
          %>
            <tr>
              <td><%= new Date(log.createdAt).toLocaleString('vi-VN') %></td>
              <td><span class="log-type <%= typeClass[log.type] %>"><%= typeLabel[log.type] || log.type %></span></td>
              <td><%= log.variantId ? 'C√≥' : '-' %></td>
              <td><%= log.quantity %></td>
              <td>
                <span class="meta"><%= log.previousStock %></span> ‚Üí 
                <strong><%= log.newStock %></strong>
              </td>
              <td>
                <%= log.reason || '-' %>
                <% if (log.note) { %>
                  <div class="meta"><%= log.note %></div>
                <% } %>
                <% if (log.orderID) { %>
                  <div class="meta">ƒê∆°n: <%= log.orderID.orderNumber || log.orderID %></div>
                <% } %>
              </td>
              <td>
                <% if (log.adminID) { %>
                  <%= log.adminID.fullName || log.adminID.email %>
                <% } else { %>
                  <span class="meta">H·ªá th·ªëng</span>
                <% } %>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    <% } %>
  </div>
</div>

<style>
.inventory-detail-grid {
  display: grid;
  grid-template-columns: 1fr 2fr;
  gap: 2rem;
  margin-bottom: 2rem;
}

.inventory-card {
  background: white;
  padding: 1.5rem;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.inventory-card h3 {
  margin-bottom: 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 2px solid var(--primary);
}

.product-detail-img {
  width: 100%;
  max-width: 300px;
  height: auto;
  border-radius: 8px;
  margin: 1rem 0;
}

.stock-section,
.variants-section {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.stock-display {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem;
  background: var(--bg-secondary);
  border-radius: 8px;
  font-size: 1.2rem;
}

.stock-value {
  font-weight: 700;
  font-size: 1.5rem;
  padding: 0.25rem 0.75rem;
  border-radius: 8px;
}

.stock-value.in-stock {
  background: #d4edda;
  color: #155724;
}

.stock-value.low-stock {
  background: #fff3cd;
  color: #856404;
}

.stock-value.out-stock {
  background: #f8d7da;
  color: #721c24;
}

.action-details {
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 0.5rem;
  margin-top: 0.5rem;
}

.action-details summary {
  cursor: pointer;
  font-weight: 600;
  padding: 0.5rem;
  user-select: none;
}

.action-details summary:hover {
  background: var(--bg-hover);
  border-radius: 4px;
}

.stock-form {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  padding: 1rem;
}

.stock-form label {
  font-weight: 600;
  margin-bottom: -0.5rem;
}

.stock-form input,
.stock-form textarea {
  padding: 0.5rem;
  border: 1px solid var(--border);
  border-radius: 4px;
}

.variant-item {
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 1rem;
  background: var(--bg-secondary);
}

.variant-header {
  display: flex;
  gap: 1rem;
  margin-bottom: 0.75rem;
  flex-wrap: wrap;
}

.log-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 1rem;
}

.log-table th,
.log-table td {
  padding: 0.75rem;
  text-align: left;
  border-bottom: 1px solid var(--border);
}

.log-table th {
  background: var(--bg-secondary);
  font-weight: 600;
}

.log-table tr:hover {
  background: var(--bg-hover);
}

.log-type {
  display: inline-block;
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  font-size: 0.85rem;
  font-weight: 500;
}

.log-import {
  background: #d4edda;
  color: #155724;
}

.log-export {
  background: #f8d7da;
  color: #721c24;
}

.log-adjust {
  background: #fff3cd;
  color: #856404;
}

.log-sale {
  background: #d1ecf1;
  color: #0c5460;
}

.btn-danger {
  background: #dc3545;
  color: white;
}

.btn-danger:hover {
  background: #c82333;
}

.btn-warning {
  background: #ffc107;
  color: #212529;
}

.btn-warning:hover {
  background: #e0a800;
}

@media (max-width: 968px) {
  .inventory-detail-grid {
    grid-template-columns: 1fr;
  }
}
</style>

<%- include('../../partials/footer') %>
